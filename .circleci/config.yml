version: 2.1

executors:
  ubuntu-focal:
    docker:
      - image: ubuntu:focal
  ubuntu-bionic:
    docker:
      - image: ubuntu:bionic

workflows:
  all-tests:
    jobs:
      - build:
          matrix:
            parameters:
              os: [ubuntu-focal, ubuntu-bionic]
      - linter
jobs:
  build:
    parameters:
      os:
        type: executor
    executor: << parameters.os >>
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run:
          name: System dependencies
          command: |
            set -ex
            PKG='apt-get install -y --no-install-recommends'
            export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
            echo "tzdata tzdata/Areas select Europe" > /tmp/preseed.txt
            echo "tzdata tzdata/Zones/Europe select Brussels" >> /tmp/preseed.txt
            debconf-set-selections /tmp/preseed.txt
            apt-get update -q
            $PKG tzdata git libgtest-dev
            $PKG pkg-config cmake make build-essential m4 autotools-dev autoconf automake libtool
            $PKG yasm nasm
      - run:
          name: Build isa-l_crypto
          command: |
            set -ex
            cd vendor/isa-l_crypto
            ./autogen.sh
            ./configure --prefix=/usr --enable-shared --enable-static --no-create --no-recursion
            make
            sudo make install
      - run:
          name: Build and Test
          command: |
            cmake .
            make
            make test
  linter:
    docker:
      - image: ubuntu:focal
    steps:
      - checkout
      - run:
          name: System dependencies
          command: |
            PKG='apt-get install -y --no-install-recommends'
            set -ex
            export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
            echo "tzdata tzdata/Areas select Europe" > /tmp/preseed.txt
            echo "tzdata tzdata/Zones/Europe select Brussels" >> /tmp/preseed.txt
            debconf-set-selections /tmp/preseed.txt
            apt-get update -q
            $PKG tzdata git libgtest-dev
            $PKG pkg-config cmake make build-essential m4 autotools-dev autoconf automake libtool
            $PKG virtualenv
            $PKG yasm nasm
      - run:
          name: Python dependencies
          command: |
            virtualenv /tmp/env
            source /tmp/env/bin/activate
            pip install --upgrade cpplint
      - run:
          name: Fetch code dependencies
          command: |
            git submodule sync
            git submodule update --init
      - run:
          name: Build isa-l_crypto
          command: |
            set -ex
            cd vendor/isa-l_crypto
            ./autogen.sh
            ./configure --prefix=/usr --enable-shared --enable-static --no-create --no-recursion
            make
            sudo make install
      - run:
          name: Build and Test
          command: |
            cmake .
            make
            make test
